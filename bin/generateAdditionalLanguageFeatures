#!/usr/bin/env php
<?php

declare(strict_types=1);

const PHP_PACKAGE_NAMESPACE = 'GamingPlatform\\Api';
const PHP_PACKAGE_PATH = '/project/php/GamingPlatform/Api';
const GO_PACKAGE_PATH = '/project/go';

function loadFiles($directory): void
{
    $entries = array_diff(scandir($directory), ['.', '..']);
    foreach ($entries as $entry) {
        $path = $directory . '/' . $entry;
        is_dir($path) ? loadFiles($path) : require_once $path;
    }
}

function findRootMessagesClasses(): array
{
    $definedMessages = array_filter(
        get_declared_classes(),
        static fn(string $class) => str_starts_with($class, PHP_PACKAGE_NAMESPACE)
            && in_array(\Google\Protobuf\Internal\Message::class, class_parents($class))
    );
    $domains = [];

    foreach ($definedMessages as $message) {
        preg_match(
                '/(?<domain>.*)\\\\(?<version>V\d+)\\\\(?<message>.*)/',
                substr($message, strlen(PHP_PACKAGE_NAMESPACE) + 1),
                $matches
        );

        if (str_contains($matches['message'], '\\')) {
            continue; // Ignore nested types.
        }

        $domainKey = $matches['domain'] . $matches['version'];
        $domains[$domainKey] ??= ['name' => $matches['domain'], 'version' => $matches['version'], 'messages' => []];
        $domains[$domainKey]['messages'][] = [
            'name' => $matches['message'],
            'type' => $matches['domain'] . '.' . $matches['message'] . '.' . strtolower($matches['version'])
        ];
    }

    return $domains;
}

function writePhpClasses(array $domains): void
{
    foreach ($domains as $domain) {
        $path = PHP_PACKAGE_PATH . '/' . $domain['name'] . '/' . $domain['version'] . '/' . $domain['name'] . $domain['version'] . '.php';
        $namespace = PHP_PACKAGE_NAMESPACE . '\\' . $domain['name'] . '\\' . $domain['version'];

        $content = '<?php' . PHP_EOL . PHP_EOL;
        $content .= 'declare(strict_types=1);' . PHP_EOL . PHP_EOL;
        $content .= 'namespace ' . $namespace . ';' . PHP_EOL . PHP_EOL;
        $content .= '// This file is auto-generated. Do not edit!' . PHP_EOL . PHP_EOL;
        $content .= 'final class ' . $domain['name'] . $domain['version'] . PHP_EOL;
        $content .= '{' . PHP_EOL;
        foreach ($domain['messages'] as $message) {
            $content .= '    public const string ' . $message['name'] . ' = \'' . $message['type'] . '\';' . PHP_EOL;
            $content .= '    public static function create' . $message['name'] . '(' . PHP_EOL;
            $content .= '        string $data' . PHP_EOL;
            $content .= '    ): ' . $message['name'] . ' {' . PHP_EOL;
            $content .= '        static $template;' . PHP_EOL;
            $content .= '        $template ??= new ' . $message['name'] . '();' . PHP_EOL;
            $content .= '        $message = clone $template;' . PHP_EOL;
            $content .= '        $message->mergeFromString($data);' . PHP_EOL;
            $content .= '        return $message;' . PHP_EOL;
            $content .= '    }' . PHP_EOL;
        }
        $content .= '}' . PHP_EOL;

        echo 'Write ' . $path . PHP_EOL;
        file_put_contents($path, $content);
    }
}

function writeGoFile(array $domains): void
{
    foreach ($domains as $domain) {
        $path = GO_PACKAGE_PATH . '/' . strtolower($domain['name'] . '/' . $domain['version']) . '/gamingplatform.go';

        $content = 'package ' . $domain['name'] . $domain['version'] . PHP_EOL . PHP_EOL;
        $content .= '// This file is auto-generated. Do not edit!' . PHP_EOL . PHP_EOL;
        foreach ($domain['messages'] as $message) {
            $content .= 'const ' . $message['name'] . 'Type = "' . $message['type'] . '"' . PHP_EOL;
        }

        echo 'Write ' . $path . PHP_EOL;
        file_put_contents($path, $content);
    }
}

loadFiles(PHP_PACKAGE_PATH);

$rootMessagesClasses = findRootMessagesClasses();
writePhpClasses($rootMessagesClasses);
writeGoFile($rootMessagesClasses);
